<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precalculus Practice Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-card-hover: #22222e;
            --accent-cyan: #00d4ff;
            --accent-magenta: #ff00aa;
            --accent-yellow: #ffdd00;
            --accent-green: #00ff88;
            --accent-orange: #ff8800;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border-subtle: #2a2a3a;
            --correct: #00ff88;
            --incorrect: #ff4466;
            --shadow-glow: 0 0 40px rgba(0, 212, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background grid */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 1rem;
            opacity: 0;
            animation: fadeInDown 0.6s ease forwards;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-cyan) 50%, var(--accent-magenta) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: fadeInDown 0.6s ease 0.1s forwards;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 300;
            opacity: 0;
            animation: fadeInDown 0.6s ease 0.2s forwards;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-bottom: 3rem;
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            opacity: 0;
            animation: fadeInUp 0.6s ease 0.3s forwards;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .stat-value.correct { color: var(--correct); }
        .stat-value.incorrect { color: var(--incorrect); }
        .stat-value.streak { color: var(--accent-yellow); }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.25rem;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            opacity: 0;
            animation: fadeInUp 0.6s ease 0.4s forwards;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .sidebar-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .topic-group {
            margin-bottom: 1.5rem;
        }

        .topic-group-title {
            font-size: 0.7rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .topic-group-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-cyan);
            border-radius: 2px;
        }

        .topic-btn {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .topic-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--accent-cyan);
            transform: translateX(4px);
        }

        .topic-btn.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 0, 170, 0.1));
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }

        .topic-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, var(--accent-cyan), var(--accent-magenta));
        }

        .topic-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .topic-btn .coming-soon {
            font-size: 0.65rem;
            color: var(--accent-yellow);
            margin-left: 0.5rem;
        }

        /* Problem Area */
        .problem-area {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 2.5rem;
            min-height: 500px;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .problem-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-magenta);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .difficulty-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .difficulty-badge.easy { background: rgba(0, 255, 136, 0.15); color: var(--correct); }
        .difficulty-badge.medium { background: rgba(255, 221, 0, 0.15); color: var(--accent-yellow); }
        .difficulty-badge.hard { background: rgba(255, 136, 0, 0.15); color: var(--accent-orange); }

        .problem-content {
            text-align: center;
            padding: 2rem 0;
        }

        .problem-instruction {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .problem-expression {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2.5rem;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            display: inline-block;
            min-width: 300px;
        }

        .problem-expression .abs-bar {
            color: var(--accent-cyan);
            padding: 0 0.15em;
        }
        
        .problem-expression .abs-inner {
            padding: 0 0.25em;
            display: inline-block;
        }
        
        .problem-expression .abs-group {
            display: inline-block;
            white-space: nowrap;
        }
        
        .problem-expression sup {
            font-size: 0.6em;
            vertical-align: super;
            line-height: 0;
        }
        
        .problem-expression .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
        }
        
        .problem-expression .fraction-num,
        .problem-expression .fraction-den {
            display: block;
            padding: 0.1em 0.3em;
        }
        
        .problem-expression .fraction-num {
            border-bottom: 2px solid var(--text-primary);
        }

        /* Answer Input */
        .answer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .math-input-container {
            width: 100%;
            max-width: 500px;
        }

        .math-editor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            padding: 1.25rem 1.5rem;
            min-height: 70px;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 4px;
            cursor: text;
            transition: all 0.3s ease;
        }

        .math-editor:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .math-editor.correct {
            border-color: var(--correct);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .math-editor.incorrect {
            border-color: var(--incorrect);
            box-shadow: 0 0 20px rgba(255, 68, 102, 0.3);
            animation: shake 0.5s ease;
        }

        /* Math elements */
        .math-element {
            display: inline-flex;
            align-items: center;
            position: relative;
        }

        .math-char {
            padding: 0 1px;
            cursor: pointer;
            border-radius: 3px;
        }

        .math-char.cursor-after::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 10%;
            height: 80%;
            width: 2px;
            background: var(--accent-cyan);
            animation: blink 1s infinite;
        }
        
        /* Operator elements (visible between structures) */
        .math-operator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            margin: 0 4px;
            font-size: 1.4rem;
            color: var(--accent-cyan);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .math-operator:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .math-operator.active {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .math-slot {
            min-width: 24px;
            min-height: 28px;
            border: 2px dashed var(--text-muted);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(0, 212, 255, 0.05);
        }

        .math-slot:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .math-slot.active {
            border-color: var(--accent-cyan);
            border-style: solid;
            background: rgba(0, 212, 255, 0.15);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .math-slot.active::after {
            content: '';
            width: 2px;
            height: 70%;
            background: var(--accent-cyan);
            animation: blink 1s infinite;
        }

        .math-slot.filled {
            border-style: solid;
            border-color: var(--border-subtle);
            background: transparent;
        }

        .math-slot.filled.active {
            border-color: var(--accent-cyan);
        }

        /* Radical structure */
        .math-radical {
            display: inline-flex;
            align-items: flex-end;
            position: relative;
        }

        .radical-index {
            font-size: 0.55em;
            margin-right: -4px;
            margin-bottom: 0.9em;
            min-width: 14px;
            min-height: 18px;
        }

        .radical-index.math-slot {
            min-width: 14px;
            min-height: 16px;
            padding: 1px 3px;
        }

        .radical-symbol {
            font-size: 1.2em;
            line-height: 1;
            margin-right: 2px;
        }

        .radical-content {
            border-top: 2px solid var(--text-primary);
            padding: 2px 6px 0 4px;
            min-width: 30px;
            min-height: 28px;
            display: inline-flex;
            align-items: center;
        }

        /* Power/exponent structure */
        .math-power {
            display: inline-flex;
            align-items: flex-start;
        }

        .power-base {
            display: inline-flex;
            align-items: center;
        }

        .power-exp {
            font-size: 0.6em;
            margin-left: 1px;
            margin-top: -0.5em;
            min-width: 14px;
            min-height: 16px;
        }
        
        /* Fraction inside exponent - angled slash style */
        .power-exp .math-fraction {
            flex-direction: row;
            align-items: center;
            font-size: 1em;
            margin: 0;
            gap: 0;
            position: relative;
        }
        
        .power-exp .math-fraction .fraction-num {
            padding: 0 1px;
            min-width: 10px;
            min-height: 12px;
            align-self: flex-end;
            margin-bottom: 2px;
        }
        
        .power-exp .math-fraction .fraction-den {
            padding: 0 1px;
            min-width: 10px;
            min-height: 12px;
            align-self: flex-start;
            margin-top: 2px;
        }
        
        .power-exp .math-fraction .fraction-bar {
            width: 14px;
            height: 2px;
            background: var(--text-primary);
            margin: 0 2px;
            transform: rotate(-65deg);
            flex-shrink: 0;
            align-self: center;
        }
        
        .power-exp .math-fraction .math-slot {
            min-width: 10px;
            min-height: 12px;
            padding: 1px 2px;
        }
        
        /* Also apply to radical index */
        .radical-index .math-fraction {
            flex-direction: row;
            align-items: center;
            font-size: 1em;
            margin: 0;
            gap: 0;
        }
        
        .radical-index .math-fraction .fraction-num {
            padding: 0 1px;
            min-width: 8px;
            min-height: 10px;
            align-self: flex-end;
            margin-bottom: 1px;
        }
        
        .radical-index .math-fraction .fraction-den {
            padding: 0 1px;
            min-width: 8px;
            min-height: 10px;
            align-self: flex-start;
            margin-top: 1px;
        }
        
        .radical-index .math-fraction .fraction-bar {
            width: 10px;
            height: 2px;
            background: var(--text-primary);
            margin: 0 1px;
            transform: rotate(-65deg);
            flex-shrink: 0;
            align-self: center;
        }
        
        .radical-index .math-fraction .math-slot {
            min-width: 8px;
            min-height: 10px;
            padding: 1px 2px;
        }

        /* Fraction structure */
        .math-fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4px;
        }

        .fraction-num, .fraction-den {
            padding: 2px 8px;
            min-width: 28px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fraction-bar {
            width: 100%;
            height: 2px;
            background: var(--text-primary);
            margin: 2px 0;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Math Keyboard */
        .math-keyboard {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-top: 0.75rem;
            max-width: 550px;
        }

        .keyboard-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .keyboard-section {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .keyboard-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .keyboard-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .math-key {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            padding: 0.45rem 0.6rem;
            min-width: 38px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .math-key:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-cyan);
            transform: translateY(-1px);
        }

        .math-key:active {
            transform: translateY(0);
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .math-key.action-key {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }

        .math-key.action-key:hover {
            background: var(--accent-magenta);
            color: var(--text-primary);
            border-color: var(--accent-magenta);
        }

        .math-key.nav-key:hover {
            background: var(--accent-yellow);
            color: var(--bg-primary);
            border-color: var(--accent-yellow);
        }

        .math-key sup {
            font-size: 0.7em;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        .submit-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            border: none;
            border-radius: 12px;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Feedback */
        .feedback {
            margin-top: 2rem;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            display: none;
            animation: fadeInUp 0.4s ease;
        }

        .feedback.show { display: block; }

        .feedback.correct {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .feedback.incorrect {
            background: rgba(255, 68, 102, 0.1);
            border: 1px solid rgba(255, 68, 102, 0.3);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .feedback-icon {
            font-size: 1.5rem;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .feedback.correct .feedback-title { color: var(--correct); }
        .feedback.incorrect .feedback-title { color: var(--incorrect); }

        .feedback-explanation {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .feedback-explanation code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-card);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--accent-cyan);
        }

        .next-btn {
            margin-top: 1.5rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.75rem 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .next-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-cyan);
        }

        /* Theory Panel */
        .theory-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        .theory-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .theory-toggle:hover { color: var(--text-primary); }

        .theory-toggle svg {
            transition: transform 0.3s ease;
        }

        .theory-toggle.open svg {
            transform: rotate(180deg);
        }

        .theory-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-subtle);
        }

        .theory-content.show { display: block; }

        .theory-content h4 {
            color: var(--accent-cyan);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .theory-content p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .theory-content .formula {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            color: var(--accent-yellow);
        }

        /* Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .sidebar-title {
                width: 100%;
            }

            .topic-group {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 0;
            }

            .topic-group-title {
                width: 100%;
            }

            .topic-btn {
                width: auto;
                flex: 1;
                min-width: 120px;
            }

            h1 { font-size: 2.5rem; }

            .stats-bar {
                gap: 1.5rem;
                flex-wrap: wrap;
            }

            .problem-expression {
                font-size: 2rem;
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="container">
        <header>
            <div class="logo">ASU Engineering Prep</div>
            <h1>Precalc Simulator</h1>
            <p class="subtitle">Master the fundamentals before Calculus I</p>
        </header>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="totalProblems">0</div>
                <div class="stat-label">Problems</div>
            </div>
            <div class="stat">
                <div class="stat-value correct" id="correctCount">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat">
                <div class="stat-value incorrect" id="incorrectCount">0</div>
                <div class="stat-label">Incorrect</div>
            </div>
            <div class="stat">
                <div class="stat-value streak" id="streakCount">0</div>
                <div class="stat-label">Streak üî•</div>
            </div>
        </div>

        <div class="main-layout">
            <aside class="sidebar">
                <div class="sidebar-title">Problem Types</div>
                
                <div class="topic-group">
                    <div class="topic-group-title">Algebra Fundamentals</div>
                    <button class="topic-btn active" data-topic="abs-simplify">Absolute Value: Simplify</button>
                    <button class="topic-btn" data-topic="abs-equations">Absolute Value: Equations</button>
                    <button class="topic-btn" data-topic="abs-inequalities">Absolute Value: Inequalities</button>
                </div>

                <div class="topic-group">
                    <div class="topic-group-title">Exponents & Radicals</div>
                    <button class="topic-btn" data-topic="exponent-laws">Exponent Laws</button>
                    <button class="topic-btn" data-topic="radicals">Radicals & Rational Exponents</button>
                </div>

                <div class="topic-group">
                    <div class="topic-group-title">Polynomials</div>
                    <button class="topic-btn locked" data-topic="factoring">Factoring <span class="coming-soon">Soon</span></button>
                    <button class="topic-btn locked" data-topic="synthetic-div">Synthetic Division <span class="coming-soon">Soon</span></button>
                </div>

                <div class="topic-group">
                    <div class="topic-group-title">Functions</div>
                    <button class="topic-btn locked" data-topic="domain-range">Domain & Range <span class="coming-soon">Soon</span></button>
                    <button class="topic-btn locked" data-topic="composition">Composition <span class="coming-soon">Soon</span></button>
                    <button class="topic-btn locked" data-topic="inverse">Inverse Functions <span class="coming-soon">Soon</span></button>
                </div>

                <div class="topic-group">
                    <div class="topic-group-title">Trigonometry</div>
                    <button class="topic-btn locked" data-topic="unit-circle">Unit Circle Values <span class="coming-soon">Soon</span></button>
                    <button class="topic-btn locked" data-topic="trig-identities">Trig Identities <span class="coming-soon">Soon</span></button>
                </div>

                <div class="topic-group">
                    <div class="topic-group-title">Logarithms</div>
                    <button class="topic-btn locked" data-topic="log-properties">Log Properties <span class="coming-soon">Soon</span></button>
                    <button class="topic-btn locked" data-topic="log-equations">Log Equations <span class="coming-soon">Soon</span></button>
                </div>
            </aside>

            <main class="problem-area">
                <div class="problem-header">
                    <span class="problem-type" id="problemType">Absolute Value: Simplify</span>
                    <span class="difficulty-badge easy" id="difficultyBadge">Easy</span>
                </div>

                <div class="problem-content">
                    <p class="problem-instruction" id="instruction">Evaluate the following expression:</p>
                    <div class="problem-expression" id="problemExpression">
                        <span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">‚àí3</span><span class="abs-bar">|</span></span> = ?
                    </div>

                    <div class="answer-section">
                        <div class="math-input-container" id="mathInputContainer">
                            <div class="math-editor" id="mathEditor" tabindex="0">
                                <!-- Math elements will be inserted here -->
                            </div>
                            <input type="hidden" id="answerInput">
                        </div>
                        
                        <div class="math-keyboard" id="mathKeyboard">
                            <div class="keyboard-row">
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Radicals</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key" data-template="sqrt" title="Square root">‚àö‚òê</button>
                                        <button class="math-key" data-template="cbrt" title="Cube root">¬≥‚àö‚òê</button>
                                        <button class="math-key" data-template="nthrt" title="nth root">‚Åø‚àö‚òê</button>
                                    </div>
                                </div>
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Exponents</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key" data-template="power" title="Power">‚òê<sup>‚òê</sup></button>
                                        <button class="math-key" data-template="frac" title="Fraction">‚òê/‚òê</button>
                                    </div>
                                </div>
                            </div>
                            <div class="keyboard-row">
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Variables</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key" data-char="a">a</button>
                                        <button class="math-key" data-char="b">b</button>
                                        <button class="math-key" data-char="x">x</button>
                                        <button class="math-key" data-char="y">y</button>
                                        <button class="math-key" data-char="m">m</button>
                                        <button class="math-key" data-char="n">n</button>
                                    </div>
                                </div>
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Numbers</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key" data-char="1">1</button>
                                        <button class="math-key" data-char="2">2</button>
                                        <button class="math-key" data-char="3">3</button>
                                        <button class="math-key" data-char="4">4</button>
                                        <button class="math-key" data-char="5">5</button>
                                        <button class="math-key" data-char="6">6</button>
                                        <button class="math-key" data-char="7">7</button>
                                        <button class="math-key" data-char="8">8</button>
                                        <button class="math-key" data-char="9">9</button>
                                        <button class="math-key" data-char="0">0</button>
                                    </div>
                                </div>
                            </div>
                            <div class="keyboard-row">
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Operators</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key" data-char="+">+</button>
                                        <button class="math-key" data-char="-">‚àí</button>
                                        <button class="math-key" data-char="*">√ó</button>
                                        <button class="math-key" data-char="/">√∑</button>
                                        <button class="math-key" data-char="(">(</button>
                                        <button class="math-key" data-char=")">)</button>
                                        <button class="math-key" data-char="," title="Separate multiple answers">,</button>
                                    </div>
                                </div>
                                <div class="keyboard-section">
                                    <div class="keyboard-label">Edit</div>
                                    <div class="keyboard-buttons">
                                        <button class="math-key nav-key" data-action="left" title="Move left">‚Üê</button>
                                        <button class="math-key nav-key" data-action="right" title="Move right">‚Üí</button>
                                        <button class="math-key action-key" data-action="backspace" title="Delete">‚å´</button>
                                        <button class="math-key action-key" data-action="clear" title="Clear all">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <button class="submit-btn" id="submitBtn">Check</button>
                        </div>
                    </div>

                    <div class="feedback" id="feedback">
                        <div class="feedback-header">
                            <span class="feedback-icon" id="feedbackIcon">‚úì</span>
                            <span class="feedback-title" id="feedbackTitle">Correct!</span>
                        </div>
                        <p class="feedback-explanation" id="feedbackExplanation"></p>
                        <button class="next-btn" id="nextBtn">Next Problem ‚Üí</button>
                    </div>
                </div>

                <div class="theory-panel">
                    <div class="theory-toggle" id="theoryToggle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        <span>Show Theory & Tips</span>
                    </div>
                    <div class="theory-content" id="theoryContent">
                        <h4>Absolute Value Definition</h4>
                        <p>The absolute value of a number is its distance from zero on the number line. It's always non-negative.</p>
                        <div class="formula">
                            |a| = a, if a ‚â• 0<br>
                            |a| = -a, if a < 0
                        </div>
                        <p><strong>Key insight:</strong> When a is negative, -a becomes positive (negative of a negative).</p>
                        <h4>Example</h4>
                        <p>If a = -6, then |a| = |-6| = -(-6) = 6</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // State
        const state = {
            currentTopic: 'abs-simplify',
            currentProblem: null,
            stats: {
                total: 0,
                correct: 0,
                incorrect: 0,
                streak: 0
            }
        };

        // Problem Generators
        const problemGenerators = {
            'abs-simplify': generateAbsSimplify,
            'abs-equations': generateAbsEquations,
            'abs-inequalities': generateAbsInequalities,
            'exponent-laws': generateExponentLaws,
            'radicals': generateRadicals
        };

        // Theory content for each topic
        const theoryContent = {
            'abs-simplify': `
                <h4>Absolute Value Definition</h4>
                <p>The absolute value of a number is its distance from zero on the number line. It's always non-negative.</p>
                <div class="formula">
                    |a| = a, if a ‚â• 0<br>
                    |a| = -a, if a < 0
                </div>
                <p><strong>Key insight:</strong> When a is negative, -a becomes positive (negative of a negative).</p>
                <h4>Example</h4>
                <p>If a = -6, then |a| = |-6| = -(-6) = 6</p>
            `,
            'abs-equations': `
                <h4>Solving Absolute Value Equations</h4>
                <p>For equations like |expression| = k where k ‚â• 0:</p>
                <div class="formula">
                    |x| = k means x = k OR x = -k
                </div>
                <p><strong>Steps:</strong></p>
                <p>1. Isolate the absolute value on one side</p>
                <p>2. If |expression| = k, set up TWO equations: expression = k AND expression = -k</p>
                <p>3. Solve each equation separately</p>
                <p>4. Check your answers in the original equation</p>
                <h4>Special Cases</h4>
                <p>‚Ä¢ |expression| = negative ‚Üí No solution (absolute value can't be negative)</p>
                <p>‚Ä¢ |expression| = 0 ‚Üí expression = 0 (only one solution)</p>
            `,
            'abs-inequalities': `
                <h4>Solving Absolute Value Inequalities</h4>
                <p>There are two main types:</p>
                <div class="formula">
                    |x| < k means -k < x < k (AND compound inequality)<br>
                    |x| > k means x < -k OR x > k (OR compound inequality)
                </div>
                <p><strong>Memory trick:</strong></p>
                <p>‚Ä¢ "Less than" ‚Üí "AND" (between values)</p>
                <p>‚Ä¢ "Greater than" ‚Üí "OR" (outside values)</p>
                <h4>Example</h4>
                <p>|x - 3| < 5 means -5 < x - 3 < 5, so -2 < x < 8</p>
                <p>|x + 2| > 4 means x + 2 < -4 OR x + 2 > 4, so x < -6 OR x > 2</p>
            `,
            'exponent-laws': `
                <h4>Exponent Laws</h4>
                <div class="formula">
                    <strong>Product Rule:</strong> a‚Åø ¬∑ a·µê = a‚Åø‚Å∫·µê<br>
                    <strong>Quotient Rule:</strong> a‚Åø / a·µê = a‚Åø‚Åª·µê<br>
                    <strong>Power Rule:</strong> (a‚Åø)·µê = a‚Åø¬∑·µê<br>
                    <strong>Negative Exponent:</strong> a‚Åª‚Åø = 1/a‚Åø<br>
                    <strong>Zero Exponent:</strong> a‚Å∞ = 1 (where a ‚â† 0)<br>
                    <strong>Reciprocal:</strong> 1/a‚Åª‚Åø = a‚Åø
                </div>
                <h4>Key Tips</h4>
                <p>‚Ä¢ Same base? Add or subtract exponents</p>
                <p>‚Ä¢ Power of a power? Multiply exponents</p>
                <p>‚Ä¢ Negative exponent? Flip to denominator (or numerator)</p>
            `,
            'radicals': `
                <h4>Radicals & Rational Exponents</h4>
                <div class="formula">
                    <strong>Square root:</strong> ‚àöa = a<sup>1/2</sup><br>
                    <strong>Cube root:</strong> ¬≥‚àöa = a<sup>1/3</sup><br>
                    <strong>nth root:</strong> ‚Åø‚àöa = a<sup>1/n</sup><br>
                    <strong>General:</strong> ‚Åø‚àö(a·µê) = a<sup>m/n</sup>
                </div>
                <h4>Radical Properties</h4>
                <div class="formula">
                    <strong>Product Rule:</strong> ‚àö(ab) = ‚àöa ¬∑ ‚àöb<br>
                    <strong>Quotient Rule:</strong> ‚àö(a/b) = ‚àöa / ‚àöb<br>
                    <strong>Power Rule:</strong> ‚Åø‚àö(a·µê) = a<sup>m/n</sup>
                </div>
                <h4>Simplifying Numerical Radicals</h4>
                <p>Factor out perfect powers: ‚àö72 = ‚àö(36¬∑2) = 6‚àö2</p>
                <p>For cube roots: ¬≥‚àö54 = ¬≥‚àö(27¬∑2) = 3¬∑¬≥‚àö2</p>
                <h4>Multi-Variable Radicals</h4>
                <p>Simplify each part: ‚àö(16x‚Å¥y¬≤) = 4x¬≤y</p>
                <p>Extract full powers: ¬≥‚àö(8x‚Å∂y¬≥) = 2x¬≤y</p>
                <h4>Radical Fractions</h4>
                <p>Simplify inside first, then take roots:</p>
                <p>¬≥‚àö(x¬≤y‚Å∂/x‚Å∏) = ¬≥‚àö(y‚Å∂/x‚Å∂) = y¬≤/x¬≤</p>
            `
        };

        // Generate Absolute Value Simplification Problems
        function generateAbsSimplify() {
            const types = ['single', 'expression', 'nested', 'withVariable'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let problem, answer, explanation, difficulty;

            switch(type) {
                case 'single':
                    const num = Math.floor(Math.random() * 41) - 20; // -20 to 20
                    const numDisplay = num < 0 ? `‚àí${Math.abs(num)}` : num.toString();
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">${numDisplay}</span><span class="abs-bar">|</span></span> = ?`;
                    answer = Math.abs(num);
                    difficulty = 'easy';
                    if (num >= 0) {
                        explanation = `Since ${num} ‚â• 0, |${num}| = ${num}`;
                    } else {
                        explanation = `Since ${num} < 0, |${num}| = ‚àí(${num}) = ${answer}`;
                    }
                    break;

                case 'expression':
                    const nums = [];
                    const ops = ['+', '-'];
                    let sum = 0;
                    const count = Math.floor(Math.random() * 3) + 2; // 2-4 numbers
                    
                    for (let i = 0; i < count; i++) {
                        const n = Math.floor(Math.random() * 31) - 15;
                        nums.push(n);
                        sum += n;
                    }
                    
                    let expr = nums[0] < 0 ? `‚àí${Math.abs(nums[0])}` : nums[0].toString();
                    for (let i = 1; i < nums.length; i++) {
                        if (nums[i] >= 0) {
                            expr += ` + ${nums[i]}`;
                        } else {
                            expr += ` ‚àí ${Math.abs(nums[i])}`;
                        }
                    }
                    
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">${expr}</span><span class="abs-bar">|</span></span> = ?`;
                    answer = Math.abs(sum);
                    difficulty = 'medium';
                    explanation = `First, simplify inside: ${expr} = ${sum}.<br>Then |${sum}| = ${answer}`;
                    break;

                case 'nested':
                    const a = Math.floor(Math.random() * 21) - 10;
                    const b = Math.floor(Math.random() * 21) - 10;
                    const innerResult = Math.abs(a) - b;
                    const aDisplay = a < 0 ? `‚àí${Math.abs(a)}` : a.toString();
                    const bDisplay = b >= 0 ? `‚àí ${b}` : `+ ${Math.abs(b)}`;
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner"><span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">${aDisplay}</span><span class="abs-bar">|</span></span> ${bDisplay}</span><span class="abs-bar">|</span></span> = ?`;
                    answer = Math.abs(innerResult);
                    difficulty = 'hard';
                    explanation = `First, |${a}| = ${Math.abs(a)}.<br>Then ${Math.abs(a)} ‚àí ${b} = ${innerResult}.<br>Finally, |${innerResult}| = ${answer}`;
                    break;

                case 'withVariable':
                    const val = Math.floor(Math.random() * 21) - 10;
                    const coef = Math.floor(Math.random() * 5) + 1;
                    const result = coef * val;
                    const coefDisplay = coef === 1 ? '' : coef;
                    problem = `If x = ${val}, evaluate <span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">${coefDisplay}x</span><span class="abs-bar">|</span></span> = ?`;
                    answer = Math.abs(result);
                    difficulty = 'medium';
                    explanation = `Substitute x = ${val}: |${coef} √ó ${val}| = |${result}| = ${answer}`;
                    break;
            }

            return {
                type: 'abs-simplify',
                typeName: 'Absolute Value: Simplify',
                instruction: 'Evaluate the following expression:',
                problem,
                answer: answer.toString(),
                explanation,
                difficulty
            };
        }

        // Generate Absolute Value Equation Problems
        function generateAbsEquations() {
            const types = ['basic', 'linear', 'twoSolutions'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let problem, answer, explanation, difficulty, instruction;

            switch(type) {
                case 'basic':
                    const k = Math.floor(Math.random() * 15) + 1;
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">x</span><span class="abs-bar">|</span></span> = ${k}`;
                    answer = `${k}, -${k}`;
                    instruction = 'Find all values of x (separate multiple answers with comma):';
                    difficulty = 'easy';
                    explanation = `|x| = ${k} means x = ${k} OR x = ‚àí${k}`;
                    break;

                case 'linear':
                    const a = Math.floor(Math.random() * 5) + 1;
                    const b = Math.floor(Math.random() * 11) - 5;
                    const c = Math.floor(Math.random() * 15) + 1;
                    // |ax + b| = c
                    // Solutions: x = (c - b)/a and x = (-c - b)/a
                    const sol1 = (c - b) / a;
                    const sol2 = (-c - b) / a;
                    const sols = [sol1, sol2].sort((x, y) => x - y);
                    
                    const bStr = b >= 0 ? `+ ${b}` : `‚àí ${Math.abs(b)}`;
                    const aStr = a === 1 ? '' : a;
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">${aStr}x ${bStr}</span><span class="abs-bar">|</span></span> = ${c}`;
                    
                    // Format answers
                    const formatNum = n => Number.isInteger(n) ? n.toString() : n.toFixed(2);
                    answer = `${formatNum(sols[0])}, ${formatNum(sols[1])}`;
                    instruction = 'Find all values of x (separate with comma, round to 2 decimals if needed):';
                    difficulty = 'medium';
                    explanation = `Set up two equations:<br>
                        ${aStr}x ${bStr} = ${c} ‚Üí x = ${formatNum(sol1)}<br>
                        ${aStr}x ${bStr} = ‚àí${c} ‚Üí x = ${formatNum(sol2)}`;
                    break;

                case 'twoSolutions':
                    // Create nice integer solutions
                    const x1 = Math.floor(Math.random() * 11) - 5;
                    const x2 = Math.floor(Math.random() * 11) - 5;
                    if (x1 === x2) return generateAbsEquations(); // retry
                    
                    // |x - m| = d where m is midpoint and d is half-distance
                    const m = (x1 + x2) / 2;
                    const d = Math.abs(x1 - x2) / 2;
                    
                    if (!Number.isInteger(m) || !Number.isInteger(d)) return generateAbsEquations();
                    
                    const mStr = m >= 0 ? `‚àí ${m}` : `+ ${Math.abs(m)}`;
                    problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">x ${mStr}</span><span class="abs-bar">|</span></span> = ${d}`;
                    const sortedSols = [x1, x2].sort((a, b) => a - b);
                    answer = `${sortedSols[0]}, ${sortedSols[1]}`;
                    instruction = 'Find all values of x (separate with comma):';
                    difficulty = 'medium';
                    explanation = `x ${mStr} = ${d} ‚Üí x = ${m + d}<br>x ${mStr} = ‚àí${d} ‚Üí x = ${m - d}`;
                    break;
            }

            return {
                type: 'abs-equations',
                typeName: 'Absolute Value: Equations',
                instruction,
                problem,
                answer,
                explanation,
                difficulty
            };
        }

        // Generate Absolute Value Inequality Problems
        function generateAbsInequalities() {
            const types = ['lessThan', 'greaterThan'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let problem, answer, explanation, difficulty, instruction;
            
            const k = Math.floor(Math.random() * 8) + 2;
            const b = Math.floor(Math.random() * 11) - 5;
            const bStr = b >= 0 ? `+ ${b}` : `‚àí ${Math.abs(b)}`;

            instruction = 'Write the solution in interval notation (use "inf" for infinity):';

            if (type === 'lessThan') {
                // |x + b| < k means -k < x + b < k, so -k - b < x < k - b
                const left = -k - b;
                const right = k - b;
                problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">x ${bStr}</span><span class="abs-bar">|</span></span> < ${k}`;
                answer = `(${left}, ${right})`;
                difficulty = 'medium';
                explanation = `|x ${bStr}| < ${k} means ‚àí${k} < x ${bStr} < ${k}<br>
                    Solve: ‚àí${k} ‚àí ${b > 0 ? b : `(${b})`} < x < ${k} ‚àí ${b > 0 ? b : `(${b})`}<br>
                    Result: ${left} < x < ${right}, or (${left}, ${right})`;
            } else {
                // |x + b| > k means x + b < -k OR x + b > k
                const left = -k - b;
                const right = k - b;
                problem = `<span class="abs-group"><span class="abs-bar">|</span><span class="abs-inner">x ${bStr}</span><span class="abs-bar">|</span></span> > ${k}`;
                answer = `(-inf, ${left}) U (${right}, inf)`;
                difficulty = 'hard';
                explanation = `|x ${bStr}| > ${k} means x ${bStr} < ‚àí${k} OR x ${bStr} > ${k}<br>
                    Solve: x < ${left} OR x > ${right}<br>
                    Result: (‚àí‚àû, ${left}) ‚à™ (${right}, ‚àû)`;
            }

            return {
                type: 'abs-inequalities',
                typeName: 'Absolute Value: Inequalities',
                instruction,
                problem,
                answer,
                explanation,
                difficulty
            };
        }

        // Generate Exponent Laws Problems
        function generateExponentLaws() {
            const types = ['product', 'quotient', 'power', 'negative', 'zero', 'combined'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let problem, answer, explanation, difficulty, instruction;
            instruction = 'Simplify the expression (write as a single power, e.g., a^5 or 1/a^3):';
            
            // Use common bases
            const bases = ['a', 'x', 'y', 'b', 'm'];
            const base = bases[Math.floor(Math.random() * bases.length)];

            switch(type) {
                case 'product': {
                    // a^n ¬∑ a^m = a^(n+m)
                    const n = Math.floor(Math.random() * 8) + 1;
                    const m = Math.floor(Math.random() * 8) + 1;
                    const result = n + m;
                    problem = `${base}<sup>${n}</sup> ¬∑ ${base}<sup>${m}</sup> = ?`;
                    answer = `${base}^${result}`;
                    difficulty = 'easy';
                    explanation = `Using the product rule: ${base}<sup>${n}</sup> ¬∑ ${base}<sup>${m}</sup> = ${base}<sup>${n}+${m}</sup> = ${base}<sup>${result}</sup>`;
                    break;
                }
                case 'quotient': {
                    // a^n / a^m = a^(n-m)
                    const n = Math.floor(Math.random() * 8) + 4;
                    const m = Math.floor(Math.random() * (n - 1)) + 1;
                    const result = n - m;
                    problem = `${base}<sup>${n}</sup> / ${base}<sup>${m}</sup> = ?`;
                    answer = `${base}^${result}`;
                    difficulty = 'easy';
                    explanation = `Using the quotient rule: ${base}<sup>${n}</sup> / ${base}<sup>${m}</sup> = ${base}<sup>${n}‚àí${m}</sup> = ${base}<sup>${result}</sup>`;
                    break;
                }
                case 'power': {
                    // (a^n)^m = a^(n¬∑m)
                    const n = Math.floor(Math.random() * 5) + 1;
                    const m = Math.floor(Math.random() * 5) + 2;
                    const result = n * m;
                    problem = `(${base}<sup>${n}</sup>)<sup>${m}</sup> = ?`;
                    answer = `${base}^${result}`;
                    difficulty = 'easy';
                    explanation = `Using the power rule: (${base}<sup>${n}</sup>)<sup>${m}</sup> = ${base}<sup>${n}¬∑${m}</sup> = ${base}<sup>${result}</sup>`;
                    break;
                }
                case 'negative': {
                    // a^(-n) = 1/a^n or 1/a^(-n) = a^n
                    const n = Math.floor(Math.random() * 6) + 1;
                    const subtype = Math.random() < 0.5 ? 'toFraction' : 'fromFraction';
                    
                    if (subtype === 'toFraction') {
                        problem = `${base}<sup>‚àí${n}</sup> = ?`;
                        answer = `1/${base}^${n}`;
                        explanation = `Negative exponent means reciprocal: ${base}<sup>‚àí${n}</sup> = 1/${base}<sup>${n}</sup>`;
                    } else {
                        problem = `1 / ${base}<sup>‚àí${n}</sup> = ?`;
                        answer = `${base}^${n}`;
                        explanation = `Reciprocal of negative exponent: 1/${base}<sup>‚àí${n}</sup> = ${base}<sup>${n}</sup>`;
                    }
                    difficulty = 'medium';
                    break;
                }
                case 'zero': {
                    // a^0 = 1
                    const coefficient = Math.floor(Math.random() * 5) + 2;
                    const innerExp = Math.floor(Math.random() * 5) + 1;
                    const useParens = Math.random() < 0.5;
                    
                    if (useParens) {
                        problem = `(${coefficient}${base}<sup>${innerExp}</sup>)<sup>0</sup> = ?`;
                        explanation = `Any non-zero expression raised to power 0 equals 1: (${coefficient}${base}<sup>${innerExp}</sup>)<sup>0</sup> = 1`;
                    } else {
                        problem = `${base}<sup>0</sup> = ?`;
                        explanation = `Any non-zero base raised to power 0 equals 1: ${base}<sup>0</sup> = 1`;
                    }
                    answer = '1';
                    difficulty = 'easy';
                    break;
                }
                case 'combined': {
                    // More complex: (a^n ¬∑ a^m) / a^p or similar
                    const n = Math.floor(Math.random() * 5) + 2;
                    const m = Math.floor(Math.random() * 5) + 2;
                    const p = Math.floor(Math.random() * 4) + 1;
                    const result = n + m - p;
                    
                    problem = `(${base}<sup>${n}</sup> ¬∑ ${base}<sup>${m}</sup>) / ${base}<sup>${p}</sup> = ?`;
                    
                    if (result > 0) {
                        answer = `${base}^${result}`;
                    } else if (result === 0) {
                        answer = '1';
                    } else {
                        answer = `1/${base}^${Math.abs(result)}`;
                    }
                    difficulty = 'hard';
                    explanation = `First, use product rule in numerator: ${base}<sup>${n}+${m}</sup> = ${base}<sup>${n+m}</sup><br>Then quotient rule: ${base}<sup>${n+m}‚àí${p}</sup> = ${base}<sup>${result}</sup>${result < 0 ? ` = 1/${base}<sup>${Math.abs(result)}</sup>` : ''}`;
                    break;
                }
            }

            return {
                type: 'exponent-laws',
                typeName: 'Exponent Laws',
                instruction,
                problem,
                answer,
                explanation,
                difficulty
            };
        }

        // Generate Radicals Problems
        function generateRadicals() {
            const types = [
                'toRational', 'fromRational', 'simplifyRadical', 'productRule', 'quotientRule',
                'numericalSimplify', 'numericalMultiply', 'numericalDivide', 'mixedRadicalMultiply',
                'multiVariableSimplify', 'radicalFractionSimplify'
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let problem, answer, explanation, difficulty, instruction;
            instruction = 'Convert or simplify (use ^ for exponents, e.g., a^(2/3)):';
            
            const bases = ['a', 'x', 'y', 'b'];
            const base = bases[Math.floor(Math.random() * bases.length)];

            switch(type) {
                case 'toRational': {
                    // ‚àöa = a^(1/2), ¬≥‚àöa = a^(1/3), etc.
                    const indices = [2, 3, 4, 5];
                    const index = indices[Math.floor(Math.random() * indices.length)];
                    const power = Math.floor(Math.random() * 4) + 1;
                    
                    const indexSymbol = index === 2 ? '‚àö' : (index === 3 ? '¬≥‚àö' : (index === 4 ? '‚Å¥‚àö' : '‚Åµ‚àö'));
                    
                    if (power === 1) {
                        problem = `${indexSymbol}${base} = ?`;
                        answer = `${base}^(1/${index})`;
                        explanation = `The ${index === 2 ? 'square' : (index === 3 ? 'cube' : index + 'th')} root equals the 1/${index} power: ${indexSymbol}${base} = ${base}<sup>1/${index}</sup>`;
                    } else {
                        problem = `${indexSymbol}(${base}<sup>${power}</sup>) = ?`;
                        // Simplify the fraction if possible
                        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                        const g = gcd(power, index);
                        const numSimp = power / g;
                        const denSimp = index / g;
                        
                        if (denSimp === 1) {
                            answer = `${base}^${numSimp}`;
                        } else {
                            answer = `${base}^(${numSimp}/${denSimp})`;
                        }
                        explanation = `${indexSymbol}(${base}<sup>${power}</sup>) = ${base}<sup>${power}/${index}</sup>${g > 1 ? ` = ${base}<sup>${numSimp}/${denSimp}</sup>` : ''}`;
                    }
                    difficulty = power === 1 ? 'easy' : 'medium';
                    break;
                }
                case 'fromRational': {
                    // a^(1/2) = ‚àöa, a^(2/3) = ¬≥‚àö(a¬≤), etc.
                    const denoms = [2, 3, 4];
                    const denom = denoms[Math.floor(Math.random() * denoms.length)];
                    const numer = Math.floor(Math.random() * 3) + 1;
                    
                    problem = `${base}<sup>${numer}/${denom}</sup> = ? (write as radical)`;
                    instruction = 'Convert to radical form (use sqrt for ‚àö, cbrt for ¬≥‚àö, or describe):';
                    
                    const indexWord = denom === 2 ? 'sqrt' : (denom === 3 ? 'cbrt' : `${denom}th root`);
                    if (numer === 1) {
                        answer = `${indexWord}(${base})`;
                    } else {
                        answer = `${indexWord}(${base}^${numer})`;
                    }
                    
                    const indexSymbol = denom === 2 ? '‚àö' : (denom === 3 ? '¬≥‚àö' : `‚Å¥‚àö`);
                    explanation = `${base}<sup>${numer}/${denom}</sup> = ${indexSymbol}(${base}<sup>${numer}</sup>)${numer === 1 ? ` = ${indexSymbol}${base}` : ''}<br>The denominator ${denom} is the index (root), numerator ${numer} is the power.`;
                    difficulty = 'medium';
                    break;
                }
                case 'simplifyRadical': {
                    // ‚àö(a^4) = a^2, ¬≥‚àö(a^6) = a^2, etc.
                    const index = Math.random() < 0.5 ? 2 : 3;
                    const multiplier = Math.floor(Math.random() * 3) + 1;
                    const power = index * multiplier;
                    
                    const indexSymbol = index === 2 ? '‚àö' : '¬≥‚àö';
                    problem = `${indexSymbol}(${base}<sup>${power}</sup>) = ?`;
                    answer = `${base}^${multiplier}`;
                    difficulty = 'easy';
                    explanation = `${indexSymbol}(${base}<sup>${power}</sup>) = ${base}<sup>${power}/${index}</sup> = ${base}<sup>${multiplier}</sup>`;
                    break;
                }
                case 'productRule': {
                    // ‚àö(ab) = ‚àöa ¬∑ ‚àöb
                    const base2 = bases.filter(b => b !== base)[0];
                    const index = Math.random() < 0.7 ? 2 : 3;
                    const indexSymbol = index === 2 ? '‚àö' : '¬≥‚àö';
                    
                    const direction = Math.random() < 0.5 ? 'split' : 'combine';
                    
                    if (direction === 'split') {
                        problem = `${indexSymbol}(${base}${base2}) = ?`;
                        answer = `${indexSymbol}${base} * ${indexSymbol}${base2}`;
                        instruction = 'Separate using the product rule (use * for multiplication):';
                        explanation = `Product rule: ${indexSymbol}(${base}${base2}) = ${indexSymbol}${base} ¬∑ ${indexSymbol}${base2}`;
                    } else {
                        problem = `${indexSymbol}${base} ¬∑ ${indexSymbol}${base2} = ?`;
                        answer = `${indexSymbol}(${base}${base2})`;
                        instruction = 'Combine using the product rule:';
                        explanation = `Product rule: ${indexSymbol}${base} ¬∑ ${indexSymbol}${base2} = ${indexSymbol}(${base}${base2})`;
                    }
                    difficulty = 'easy';
                    break;
                }
                case 'quotientRule': {
                    // ‚àö(a/b) = ‚àöa / ‚àöb
                    const base2 = bases.filter(b => b !== base)[0];
                    const index = Math.random() < 0.7 ? 2 : 3;
                    const indexSymbol = index === 2 ? '‚àö' : '¬≥‚àö';
                    
                    const direction = Math.random() < 0.5 ? 'split' : 'combine';
                    
                    if (direction === 'split') {
                        problem = `${indexSymbol}(${base}/${base2}) = ?`;
                        answer = `${indexSymbol}${base} / ${indexSymbol}${base2}`;
                        instruction = 'Separate using the quotient rule:';
                        explanation = `Quotient rule: ${indexSymbol}(${base}/${base2}) = ${indexSymbol}${base} / ${indexSymbol}${base2}`;
                    } else {
                        problem = `${indexSymbol}${base} / ${indexSymbol}${base2} = ?`;
                        answer = `${indexSymbol}(${base}/${base2})`;
                        instruction = 'Combine using the quotient rule:';
                        explanation = `Quotient rule: ${indexSymbol}${base} / ${indexSymbol}${base2} = ${indexSymbol}(${base}/${base2})`;
                    }
                    difficulty = 'easy';
                    break;
                }
                
                // ============ NEW ADVANCED PROBLEM TYPES ============
                
                case 'numericalSimplify': {
                    // ‚àö72 = 6‚àö2, ¬≥‚àö54 = 3¬≥‚àö2, etc.
                    instruction = 'Simplify the radical completely:';
                    
                    // Perfect squares/cubes with remainders
                    const sqrtProblems = [
                        { n: 72, coef: 6, remain: 2 },   // ‚àö72 = ‚àö(36¬∑2) = 6‚àö2
                        { n: 50, coef: 5, remain: 2 },   // ‚àö50 = ‚àö(25¬∑2) = 5‚àö2
                        { n: 48, coef: 4, remain: 3 },   // ‚àö48 = ‚àö(16¬∑3) = 4‚àö3
                        { n: 75, coef: 5, remain: 3 },   // ‚àö75 = ‚àö(25¬∑3) = 5‚àö3
                        { n: 98, coef: 7, remain: 2 },   // ‚àö98 = ‚àö(49¬∑2) = 7‚àö2
                        { n: 128, coef: 8, remain: 2 },  // ‚àö128 = ‚àö(64¬∑2) = 8‚àö2
                        { n: 45, coef: 3, remain: 5 },   // ‚àö45 = ‚àö(9¬∑5) = 3‚àö5
                        { n: 200, coef: 10, remain: 2 }, // ‚àö200 = ‚àö(100¬∑2) = 10‚àö2
                        { n: 18, coef: 3, remain: 2 },   // ‚àö18 = ‚àö(9¬∑2) = 3‚àö2
                        { n: 32, coef: 4, remain: 2 },   // ‚àö32 = ‚àö(16¬∑2) = 4‚àö2
                    ];
                    
                    const cbrtProblems = [
                        { n: 54, coef: 3, remain: 2 },   // ¬≥‚àö54 = ¬≥‚àö(27¬∑2) = 3¬≥‚àö2
                        { n: 16, coef: 2, remain: 2 },   // ¬≥‚àö16 = ¬≥‚àö(8¬∑2) = 2¬≥‚àö2
                        { n: 24, coef: 2, remain: 3 },   // ¬≥‚àö24 = ¬≥‚àö(8¬∑3) = 2¬≥‚àö3
                        { n: 128, coef: 4, remain: 2 },  // ¬≥‚àö128 = ¬≥‚àö(64¬∑2) = 4¬≥‚àö2
                        { n: 250, coef: 5, remain: 2 },  // ¬≥‚àö250 = ¬≥‚àö(125¬∑2) = 5¬≥‚àö2
                    ];
                    
                    const useCube = Math.random() < 0.3;
                    const problems = useCube ? cbrtProblems : sqrtProblems;
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    const indexSymbol = useCube ? '¬≥‚àö' : '‚àö';
                    
                    problem = `${indexSymbol}${p.n} = ?`;
                    answer = `${p.coef}${indexSymbol}${p.remain}`;
                    
                    const perfectPower = Math.pow(p.coef, useCube ? 3 : 2);
                    explanation = `${indexSymbol}${p.n} = ${indexSymbol}(${perfectPower} ¬∑ ${p.remain}) = ${indexSymbol}${perfectPower} ¬∑ ${indexSymbol}${p.remain} = ${p.coef}${indexSymbol}${p.remain}`;
                    difficulty = 'medium';
                    break;
                }
                
                case 'numericalMultiply': {
                    // ‚àö50 ¬∑ ‚àö2 = ‚àö100 = 10
                    instruction = 'Multiply and simplify:';
                    
                    const problems = [
                        { a: 50, b: 2, result: 10 },    // ‚àö50 ¬∑ ‚àö2 = ‚àö100 = 10
                        { a: 8, b: 2, result: 4 },      // ‚àö8 ¬∑ ‚àö2 = ‚àö16 = 4
                        { a: 12, b: 3, result: 6 },     // ‚àö12 ¬∑ ‚àö3 = ‚àö36 = 6
                        { a: 18, b: 2, result: 6 },     // ‚àö18 ¬∑ ‚àö2 = ‚àö36 = 6
                        { a: 5, b: 20, result: 10 },    // ‚àö5 ¬∑ ‚àö20 = ‚àö100 = 10
                        { a: 6, b: 6, result: 6 },      // ‚àö6 ¬∑ ‚àö6 = ‚àö36 = 6
                        { a: 3, b: 27, result: 9 },     // ‚àö3 ¬∑ ‚àö27 = ‚àö81 = 9
                        { a: 7, b: 7, result: 7 },      // ‚àö7 ¬∑ ‚àö7 = ‚àö49 = 7
                        { a: 2, b: 32, result: 8 },     // ‚àö2 ¬∑ ‚àö32 = ‚àö64 = 8
                        { a: 45, b: 5, result: 15 },    // ‚àö45 ¬∑ ‚àö5 = ‚àö225 = 15
                    ];
                    
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    const product = p.a * p.b;
                    
                    problem = `‚àö${p.a} ¬∑ ‚àö${p.b} = ?`;
                    answer = `${p.result}`;
                    explanation = `‚àö${p.a} ¬∑ ‚àö${p.b} = ‚àö(${p.a} ¬∑ ${p.b}) = ‚àö${product} = ${p.result}`;
                    difficulty = 'medium';
                    break;
                }
                
                case 'numericalDivide': {
                    // ‚àö512 / ‚àö2 = ‚àö256 = 16
                    instruction = 'Divide and simplify:';
                    
                    const problems = [
                        { a: 512, b: 2, result: 16 },   // ‚àö512 / ‚àö2 = ‚àö256 = 16
                        { a: 72, b: 2, result: 6 },     // ‚àö72 / ‚àö2 = ‚àö36 = 6
                        { a: 200, b: 2, result: 10 },   // ‚àö200 / ‚àö2 = ‚àö100 = 10
                        { a: 98, b: 2, result: 7 },     // ‚àö98 / ‚àö2 = ‚àö49 = 7
                        { a: 75, b: 3, result: 5 },     // ‚àö75 / ‚àö3 = ‚àö25 = 5
                        { a: 147, b: 3, result: 7 },    // ‚àö147 / ‚àö3 = ‚àö49 = 7
                        { a: 245, b: 5, result: 7 },    // ‚àö245 / ‚àö5 = ‚àö49 = 7
                        { a: 180, b: 5, result: 6 },    // ‚àö180 / ‚àö5 = ‚àö36 = 6
                        { a: 288, b: 2, result: 12 },   // ‚àö288 / ‚àö2 = ‚àö144 = 12
                        { a: 162, b: 2, result: 9 },    // ‚àö162 / ‚àö2 = ‚àö81 = 9
                    ];
                    
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    const quotient = p.a / p.b;
                    
                    problem = `‚àö${p.a} / ‚àö${p.b} = ?`;
                    answer = `${p.result}`;
                    explanation = `‚àö${p.a} / ‚àö${p.b} = ‚àö(${p.a}/${p.b}) = ‚àö${quotient} = ${p.result}`;
                    difficulty = 'medium';
                    break;
                }
                
                case 'mixedRadicalMultiply': {
                    // ¬≥‚àö8 ¬∑ ‚Å¥‚àö81 = 2 ¬∑ 3 = 6
                    instruction = 'Simplify each radical and multiply:';
                    
                    const problems = [
                        { idx1: 3, n1: 8, val1: 2, idx2: 4, n2: 81, val2: 3, result: 6 },    // ¬≥‚àö8 ¬∑ ‚Å¥‚àö81 = 2¬∑3 = 6
                        { idx1: 2, n1: 16, val1: 4, idx2: 3, n2: 27, val2: 3, result: 12 },  // ‚àö16 ¬∑ ¬≥‚àö27 = 4¬∑3 = 12
                        { idx1: 2, n1: 25, val1: 5, idx2: 3, n2: 8, val2: 2, result: 10 },   // ‚àö25 ¬∑ ¬≥‚àö8 = 5¬∑2 = 10
                        { idx1: 3, n1: 27, val1: 3, idx2: 4, n2: 16, val2: 2, result: 6 },   // ¬≥‚àö27 ¬∑ ‚Å¥‚àö16 = 3¬∑2 = 6
                        { idx1: 2, n1: 49, val1: 7, idx2: 3, n2: 8, val2: 2, result: 14 },   // ‚àö49 ¬∑ ¬≥‚àö8 = 7¬∑2 = 14
                        { idx1: 4, n1: 16, val1: 2, idx2: 2, n2: 81, val2: 9, result: 18 },  // ‚Å¥‚àö16 ¬∑ ‚àö81 = 2¬∑9 = 18
                        { idx1: 3, n1: 64, val1: 4, idx2: 2, n2: 25, val2: 5, result: 20 },  // ¬≥‚àö64 ¬∑ ‚àö25 = 4¬∑5 = 20
                        { idx1: 2, n1: 36, val1: 6, idx2: 3, n2: 125, val2: 5, result: 30 }, // ‚àö36 ¬∑ ¬≥‚àö125 = 6¬∑5 = 30
                    ];
                    
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    const sym1 = p.idx1 === 2 ? '‚àö' : (p.idx1 === 3 ? '¬≥‚àö' : '‚Å¥‚àö');
                    const sym2 = p.idx2 === 2 ? '‚àö' : (p.idx2 === 3 ? '¬≥‚àö' : '‚Å¥‚àö');
                    
                    problem = `${sym1}${p.n1} ¬∑ ${sym2}${p.n2} = ?`;
                    answer = `${p.result}`;
                    explanation = `${sym1}${p.n1} = ${p.val1} and ${sym2}${p.n2} = ${p.val2}<br>${p.val1} ¬∑ ${p.val2} = ${p.result}`;
                    difficulty = 'medium';
                    break;
                }
                
                case 'multiVariableSimplify': {
                    // ¬≥‚àö(16x‚Åµy‚Å¥z) = 2xy¬≥‚àö(2x¬≤yz)
                    instruction = 'Simplify the radical completely:';
                    
                    const problems = [
                        {
                            index: 3,
                            display: '¬≥‚àö(8x<sup>6</sup>y<sup>3</sup>)',
                            answer: '2x^2*y',
                            explanation: '¬≥‚àö(8x<sup>6</sup>y<sup>3</sup>) = ¬≥‚àö8 ¬∑ ¬≥‚àöx<sup>6</sup> ¬∑ ¬≥‚àöy<sup>3</sup> = 2 ¬∑ x<sup>2</sup> ¬∑ y = 2x¬≤y'
                        },
                        {
                            index: 2,
                            display: '‚àö(16x<sup>4</sup>y<sup>2</sup>)',
                            answer: '4x^2*y',
                            explanation: '‚àö(16x<sup>4</sup>y<sup>2</sup>) = ‚àö16 ¬∑ ‚àöx<sup>4</sup> ¬∑ ‚àöy<sup>2</sup> = 4 ¬∑ x<sup>2</sup> ¬∑ y = 4x¬≤y'
                        },
                        {
                            index: 2,
                            display: '‚àö(25a<sup>2</sup>b<sup>4</sup>)',
                            answer: '5a*b^2',
                            explanation: '‚àö(25a<sup>2</sup>b<sup>4</sup>) = ‚àö25 ¬∑ ‚àöa<sup>2</sup> ¬∑ ‚àöb<sup>4</sup> = 5 ¬∑ a ¬∑ b<sup>2</sup> = 5ab¬≤'
                        },
                        {
                            index: 3,
                            display: '¬≥‚àö(27a<sup>3</sup>b<sup>6</sup>)',
                            answer: '3a*b^2',
                            explanation: '¬≥‚àö(27a<sup>3</sup>b<sup>6</sup>) = ¬≥‚àö27 ¬∑ ¬≥‚àöa<sup>3</sup> ¬∑ ¬≥‚àöb<sup>6</sup> = 3 ¬∑ a ¬∑ b<sup>2</sup> = 3ab¬≤'
                        },
                        {
                            index: 2,
                            display: '‚àö(36x<sup>6</sup>y<sup>4</sup>)',
                            answer: '6x^3*y^2',
                            explanation: '‚àö(36x<sup>6</sup>y<sup>4</sup>) = ‚àö36 ¬∑ ‚àöx<sup>6</sup> ¬∑ ‚àöy<sup>4</sup> = 6 ¬∑ x<sup>3</sup> ¬∑ y<sup>2</sup> = 6x¬≥y¬≤'
                        },
                        {
                            index: 4,
                            display: '‚Å¥‚àö(16x<sup>8</sup>y<sup>4</sup>)',
                            answer: '2x^2*y',
                            explanation: '‚Å¥‚àö(16x<sup>8</sup>y<sup>4</sup>) = ‚Å¥‚àö16 ¬∑ ‚Å¥‚àöx<sup>8</sup> ¬∑ ‚Å¥‚àöy<sup>4</sup> = 2 ¬∑ x<sup>2</sup> ¬∑ y = 2x¬≤y'
                        },
                        {
                            index: 3,
                            display: '¬≥‚àö(64x<sup>9</sup>y<sup>6</sup>)',
                            answer: '4x^3*y^2',
                            explanation: '¬≥‚àö(64x<sup>9</sup>y<sup>6</sup>) = ¬≥‚àö64 ¬∑ ¬≥‚àöx<sup>9</sup> ¬∑ ¬≥‚àöy<sup>6</sup> = 4 ¬∑ x<sup>3</sup> ¬∑ y<sup>2</sup> = 4x¬≥y¬≤'
                        },
                        {
                            index: 2,
                            display: '‚àö(100a<sup>4</sup>b<sup>2</sup>c<sup>6</sup>)',
                            answer: '10a^2*b*c^3',
                            explanation: '‚àö(100a<sup>4</sup>b<sup>2</sup>c<sup>6</sup>) = 10 ¬∑ a<sup>2</sup> ¬∑ b ¬∑ c<sup>3</sup> = 10a¬≤bc¬≥'
                        },
                    ];
                    
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    problem = p.display + ' = ?';
                    answer = p.answer;
                    explanation = p.explanation;
                    difficulty = 'hard';
                    break;
                }
                
                case 'radicalFractionSimplify': {
                    // ¬≥‚àö(x¬≤y‚Å∂/x‚Å∏) = y¬≤/x¬≤
                    instruction = 'Simplify the radical fraction:';
                    
                    const problems = [
                        {
                            display: '¬≥‚àö(x<sup>2</sup>y<sup>6</sup> / x<sup>8</sup>)',
                            answer: 'y^2/x^2',
                            explanation: '¬≥‚àö(x<sup>2</sup>y<sup>6</sup>/x<sup>8</sup>) = ¬≥‚àö(y<sup>6</sup>/x<sup>6</sup>) = ¬≥‚àöy<sup>6</sup> / ¬≥‚àöx<sup>6</sup> = y<sup>2</sup>/x<sup>2</sup>'
                        },
                        {
                            display: '‚àö(a<sup>4</sup>b<sup>2</sup> / a<sup>2</sup>)',
                            answer: 'a*b',
                            explanation: '‚àö(a<sup>4</sup>b<sup>2</sup>/a<sup>2</sup>) = ‚àö(a<sup>2</sup>b<sup>2</sup>) = ab'
                        },
                        {
                            display: '‚àö(x<sup>6</sup> / y<sup>4</sup>)',
                            answer: 'x^3/y^2',
                            explanation: '‚àö(x<sup>6</sup>/y<sup>4</sup>) = ‚àöx<sup>6</sup> / ‚àöy<sup>4</sup> = x<sup>3</sup>/y<sup>2</sup>'
                        },
                        {
                            display: '¬≥‚àö(a<sup>9</sup> / b<sup>6</sup>)',
                            answer: 'a^3/b^2',
                            explanation: '¬≥‚àö(a<sup>9</sup>/b<sup>6</sup>) = ¬≥‚àöa<sup>9</sup> / ¬≥‚àöb<sup>6</sup> = a<sup>3</sup>/b<sup>2</sup>'
                        },
                        {
                            display: '‚àö(49x<sup>4</sup> / y<sup>6</sup>)',
                            answer: '7x^2/y^3',
                            explanation: '‚àö(49x<sup>4</sup>/y<sup>6</sup>) = ‚àö49 ¬∑ ‚àöx<sup>4</sup> / ‚àöy<sup>6</sup> = 7x<sup>2</sup>/y<sup>3</sup>'
                        },
                        {
                            display: '‚Å¥‚àö(x<sup>8</sup>y<sup>4</sup> / z<sup>12</sup>)',
                            answer: 'x^2*y/z^3',
                            explanation: '‚Å¥‚àö(x<sup>8</sup>y<sup>4</sup>/z<sup>12</sup>) = x<sup>2</sup>y/z<sup>3</sup>'
                        },
                        {
                            display: '‚àö(81a<sup>2</sup> / b<sup>4</sup>)',
                            answer: '9a/b^2',
                            explanation: '‚àö(81a<sup>2</sup>/b<sup>4</sup>) = ‚àö81 ¬∑ ‚àöa<sup>2</sup> / ‚àöb<sup>4</sup> = 9a/b<sup>2</sup>'
                        },
                        {
                            display: '¬≥‚àö(8x<sup>6</sup> / y<sup>9</sup>)',
                            answer: '2x^2/y^3',
                            explanation: '¬≥‚àö(8x<sup>6</sup>/y<sup>9</sup>) = ¬≥‚àö8 ¬∑ ¬≥‚àöx<sup>6</sup> / ¬≥‚àöy<sup>9</sup> = 2x<sup>2</sup>/y<sup>3</sup>'
                        },
                    ];
                    
                    const p = problems[Math.floor(Math.random() * problems.length)];
                    problem = p.display + ' = ?';
                    answer = p.answer;
                    explanation = p.explanation;
                    difficulty = 'hard';
                    break;
                }
            }

            return {
                type: 'radicals',
                typeName: 'Radicals & Rational Exponents',
                instruction,
                problem,
                answer,
                explanation,
                difficulty
            };
        }

        // UI Updates
        function updateStats() {
            document.getElementById('totalProblems').textContent = state.stats.total;
            document.getElementById('correctCount').textContent = state.stats.correct;
            document.getElementById('incorrectCount').textContent = state.stats.incorrect;
            document.getElementById('streakCount').textContent = state.stats.streak;
        }

        // ============ STRUCTURED MATH EDITOR ============
        
        // Editor state
        const editorState = {
            elements: [], // Array of math elements
            activeSlot: null, // Currently active slot element
            cursorPosition: 0 // For simple text entry
        };

        // Create a simple character element
        function createCharElement(char) {
            const span = document.createElement('span');
            span.className = 'math-element math-char';
            span.textContent = char;
            span.dataset.type = 'char';
            span.dataset.value = char;
            return span;
        }
        
        // Create an operator element (visible, styled differently)
        function createOperatorElement(operator) {
            const span = document.createElement('span');
            span.className = 'math-element math-operator';
            span.dataset.type = 'operator';
            
            // Display nicer symbols
            const displayMap = {
                '*': '√ó',
                '/': '√∑',
                '+': '+',
                '-': '‚àí'
            };
            span.textContent = displayMap[operator] || operator;
            span.dataset.value = operator;
            span.tabIndex = 0;
            return span;
        }
        
        // Check if character is an operator
        function isOperator(char) {
            return ['+', '-', '*', '/', '√ó', '√∑'].includes(char);
        }

        // Create an empty slot (placeholder)
        function createSlot(type = 'default') {
            const span = document.createElement('span');
            span.className = 'math-slot';
            span.dataset.type = 'slot';
            span.dataset.slotType = type;
            span.tabIndex = 0;
            return span;
        }

        // Create a radical structure: ‚Åø‚àö(content)
        function createRadicalElement(indexValue = '', hasIndex = true) {
            const wrapper = document.createElement('span');
            wrapper.className = 'math-element math-radical';
            wrapper.dataset.type = 'radical';
            
            // Index slot (for nth root)
            if (hasIndex) {
                const indexSlot = createSlot('index');
                indexSlot.className += ' radical-index';
                if (indexValue) {
                    indexSlot.textContent = indexValue;
                    indexSlot.classList.add('filled');
                    indexSlot.dataset.value = indexValue;
                }
                wrapper.appendChild(indexSlot);
            }
            
            // Radical symbol
            const symbol = document.createElement('span');
            symbol.className = 'radical-symbol';
            symbol.textContent = '‚àö';
            wrapper.appendChild(symbol);
            
            // Radicand (content under the radical)
            const content = document.createElement('span');
            content.className = 'radical-content';
            const contentSlot = createSlot('radicand');
            content.appendChild(contentSlot);
            wrapper.appendChild(content);
            
            return wrapper;
        }

        // Create a power structure: base^exp
        function createPowerElement() {
            const wrapper = document.createElement('span');
            wrapper.className = 'math-element math-power';
            wrapper.dataset.type = 'power';
            
            // Base slot
            const baseSlot = createSlot('base');
            baseSlot.className += ' power-base';
            wrapper.appendChild(baseSlot);
            
            // Exponent slot
            const expSlot = createSlot('exponent');
            expSlot.className += ' power-exp';
            wrapper.appendChild(expSlot);
            
            return wrapper;
        }

        // Create a fraction structure
        function createFractionElement() {
            const wrapper = document.createElement('span');
            wrapper.className = 'math-element math-fraction';
            wrapper.dataset.type = 'fraction';
            
            // Numerator
            const numSlot = createSlot('numerator');
            numSlot.className += ' fraction-num';
            wrapper.appendChild(numSlot);
            
            // Fraction bar
            const bar = document.createElement('span');
            bar.className = 'fraction-bar';
            wrapper.appendChild(bar);
            
            // Denominator
            const denSlot = createSlot('denominator');
            denSlot.className += ' fraction-den';
            wrapper.appendChild(denSlot);
            
            return wrapper;
        }

        // Get all navigable elements (slots and operators) in document order
        function getAllSlots() {
            return Array.from(document.querySelectorAll('#mathEditor .math-slot'));
        }
        
        // Get all focusable elements including operators
        function getAllFocusableElements() {
            return Array.from(document.querySelectorAll('#mathEditor .math-slot, #mathEditor .math-operator'));
        }

        // Set active slot
        function setActiveSlot(slot) {
            // Clear previous active from both slots and operators
            getAllFocusableElements().forEach(s => s.classList.remove('active'));
            
            if (slot) {
                slot.classList.add('active');
                editorState.activeSlot = slot;
                slot.focus();
            } else {
                editorState.activeSlot = null;
            }
        }

        // Find next/previous focusable element (slot or operator)
        function navigateSlot(direction) {
            const elements = getAllFocusableElements();
            if (elements.length === 0) return;
            
            const currentIndex = elements.indexOf(editorState.activeSlot);
            let newIndex;
            
            if (direction === 'right') {
                newIndex = currentIndex < elements.length - 1 ? currentIndex + 1 : 0;
            } else {
                newIndex = currentIndex > 0 ? currentIndex - 1 : elements.length - 1;
            }
            
            setActiveSlot(elements[newIndex]);
        }

        // Insert character into active slot
        function insertIntoSlot(char) {
            const editor = document.getElementById('mathEditor');
            
            // If no slot active, ensure we have one
            if (!editorState.activeSlot) {
                ensureSlotExists();
            }
            
            // Now we should have an active slot
            if (!editorState.activeSlot) {
                return; // Safety check
            }
            
            const slot = editorState.activeSlot;
            
            // Check if we're in an exponent slot and typing /
            // This should create a fraction for the exponent
            const isInExponent = slot.classList.contains('power-exp') || 
                                 slot.closest('.power-exp') !== null;
            
            if ((char === '/' || char === '√∑') && isInExponent) {
                // Get the current value as numerator
                const currentValue = slot.dataset.value || '';
                
                // Create a fraction element
                const fracElement = createFractionElement();
                const numSlot = fracElement.querySelector('[data-slot-type="numerator"]');
                const denSlot = fracElement.querySelector('[data-slot-type="denominator"]');
                
                // If there's existing content, put it in the numerator
                if (currentValue && currentValue !== '[complex]') {
                    numSlot.textContent = currentValue;
                    numSlot.dataset.value = currentValue;
                    numSlot.classList.add('filled');
                }
                
                // Clear the slot and insert fraction
                slot.innerHTML = '';
                slot.appendChild(fracElement);
                slot.classList.add('filled');
                slot.dataset.value = '[complex]';
                
                // Focus on denominator if numerator has value, else numerator
                setActiveSlot(currentValue ? denSlot : numSlot);
                return;
            }
            
            // Check if this is an operator - handle specially
            if (isOperator(char)) {
                // Operators go between elements, not inside slots
                // Find the parent element and insert operator after it
                const parentElement = slot.closest('.math-element') || slot;
                const operatorEl = createOperatorElement(char);
                
                // Insert operator after the current element
                if (parentElement.nextSibling) {
                    editor.insertBefore(operatorEl, parentElement.nextSibling);
                } else {
                    editor.appendChild(operatorEl);
                }
                
                // Create a new slot after the operator for the next input
                const newSlot = createSlot('main');
                if (operatorEl.nextSibling) {
                    editor.insertBefore(newSlot, operatorEl.nextSibling);
                } else {
                    editor.appendChild(newSlot);
                }
                
                // Move focus to the new slot
                setActiveSlot(newSlot);
                return;
            }
            
            // Regular character - insert into slot
            const currentValue = slot.dataset.value || '';
            const newValue = currentValue + char;
            
            slot.textContent = newValue;
            slot.dataset.value = newValue;
            slot.classList.add('filled');
        }

        // Remove last character from active slot
        function backspaceSlot() {
            const editor = document.getElementById('mathEditor');
            
            // If no active slot, ensure we have one
            if (!editorState.activeSlot) {
                ensureSlotExists();
                return;
            }
            
            const activeEl = editorState.activeSlot;
            
            // Check if we're on an operator - delete it
            if (activeEl.classList.contains('math-operator')) {
                const allElements = getAllFocusableElements();
                const currentIndex = allElements.indexOf(activeEl);
                activeEl.remove();
                
                // Navigate to previous element
                const remainingElements = getAllFocusableElements();
                if (remainingElements.length > 0) {
                    const newIndex = Math.max(0, currentIndex - 1);
                    setActiveSlot(remainingElements[newIndex] || remainingElements[0]);
                } else {
                    ensureSlotExists();
                }
                return;
            }
            
            const slot = activeEl;
            const currentValue = slot.dataset.value || '';
            
            if (currentValue.length > 0) {
                const newValue = currentValue.slice(0, -1);
                slot.textContent = newValue;
                slot.dataset.value = newValue;
                
                if (newValue.length === 0) {
                    slot.classList.remove('filled');
                }
            } else {
                // If slot is empty, try to remove the parent structure
                const parent = slot.closest('.math-element');
                if (parent && (parent.classList.contains('math-radical') || 
                    parent.classList.contains('math-power') ||
                    parent.classList.contains('math-fraction'))) {
                    const elements = getAllFocusableElements();
                    const currentIndex = elements.indexOf(slot);
                    parent.remove();
                    
                    // Navigate to previous element or first available
                    const remainingElements = getAllFocusableElements();
                    if (remainingElements.length > 0) {
                        const newIndex = Math.min(currentIndex, remainingElements.length - 1);
                        setActiveSlot(remainingElements[Math.max(0, newIndex - 1)] || remainingElements[0]);
                    } else {
                        // No slots left, create one
                        ensureSlotExists();
                    }
                } else if (slot.dataset.slotType === 'main') {
                    // It's the main slot and it's empty - just keep it
                    return;
                }
            }
            
            // Always ensure at least one slot exists
            ensureSlotExists();
        }
        
        // Ensure there's always at least one slot in the editor
        function ensureSlotExists() {
            const editor = document.getElementById('mathEditor');
            const slots = getAllSlots();
            
            if (slots.length === 0) {
                const initialSlot = createSlot('main');
                editor.appendChild(initialSlot);
                setActiveSlot(initialSlot);
            } else if (!editorState.activeSlot) {
                setActiveSlot(slots[0]);
            }
        }

        // Clear the editor
        function clearEditor() {
            const editor = document.getElementById('mathEditor');
            editor.innerHTML = '';
            editorState.elements = [];
            editorState.activeSlot = null;
            
            // Add initial slot
            const initialSlot = createSlot('main');
            editor.appendChild(initialSlot);
            setActiveSlot(initialSlot);
        }

        // Insert a template (radical, power, fraction)
        function insertTemplate(templateType) {
            const editor = document.getElementById('mathEditor');
            let element;
            let firstSlot;
            
            switch(templateType) {
                case 'sqrt':
                    element = createRadicalElement('', false);
                    firstSlot = element.querySelector('.math-slot');
                    break;
                case 'cbrt':
                    element = createRadicalElement('3', true);
                    // For cube root, the first slot to fill is the radicand
                    firstSlot = element.querySelector('[data-slot-type="radicand"]');
                    break;
                case 'nthrt':
                    element = createRadicalElement('', true);
                    firstSlot = element.querySelector('.radical-index');
                    break;
                case 'power':
                    element = createPowerElement();
                    firstSlot = element.querySelector('[data-slot-type="base"]');
                    break;
                case 'frac':
                    element = createFractionElement();
                    firstSlot = element.querySelector('[data-slot-type="numerator"]');
                    break;
            }
            
            if (element) {
                if (editorState.activeSlot && !editorState.activeSlot.dataset.value) {
                    // Check if the active slot is inside a structure (not the main slot)
                    const parentStructure = editorState.activeSlot.closest('.math-power, .math-radical, .math-fraction');
                    const isMainSlot = editorState.activeSlot.dataset.slotType === 'main';
                    
                    if (parentStructure && !isMainSlot) {
                        // Insert the new element INSIDE the current slot (nested structure)
                        // Convert the slot to a container that holds the new element
                        const slot = editorState.activeSlot;
                        slot.innerHTML = '';
                        slot.appendChild(element);
                        slot.classList.add('filled');
                        slot.dataset.value = '[complex]'; // Mark as containing complex structure
                    } else {
                        // It's a main slot or top-level, replace it entirely
                        editorState.activeSlot.replaceWith(element);
                    }
                } else {
                    // No active slot or slot has value - append to editor
                    editor.appendChild(element);
                }
                
                setActiveSlot(firstSlot);
            }
        }

        // Convert editor content to string for answer checking
        function getEditorValue() {
            const editor = document.getElementById('mathEditor');
            return serializeElement(editor);
        }

        function serializeElement(element) {
            let result = '';
            
            for (const child of element.children) {
                if (child.classList.contains('math-char')) {
                    result += child.dataset.value || child.textContent;
                } else if (child.classList.contains('math-operator')) {
                    // Operator element - use its stored value
                    result += ` ${child.dataset.value || child.textContent} `;
                } else if (child.classList.contains('math-slot')) {
                    // Check if slot contains nested structure (children take priority)
                    if (child.children.length > 0) {
                        result += serializeElement(child);
                    } else {
                        // Only use dataset.value if no children and value is not [complex]
                        const val = child.dataset.value || '';
                        if (val !== '[complex]') {
                            result += val;
                        }
                    }
                } else if (child.classList.contains('radical-content')) {
                    // Handle radical-content directly - serialize its contents
                    result += serializeElement(child);
                } else if (child.classList.contains('math-radical')) {
                    const indexEl = child.querySelector(':scope > .radical-index, :scope > span > .radical-index');
                    const contentEl = child.querySelector('.radical-content');
                    
                    // Get index - check for nested content first
                    let index = '2';
                    if (indexEl) {
                        if (indexEl.children.length > 0) {
                            index = serializeElement(indexEl);
                        } else {
                            index = indexEl.dataset.value || '2';
                        }
                    }
                    
                    const content = contentEl ? serializeElement(contentEl) : '';
                    
                    if (index === '2' || index === '' || index === '[complex]') {
                        result += `‚àö(${content})`;
                    } else if (index === '3') {
                        result += `¬≥‚àö(${content})`;
                    } else if (index === '4') {
                        result += `‚Å¥‚àö(${content})`;
                    } else {
                        result += `${index}‚àö(${content})`;
                    }
                } else if (child.classList.contains('math-power')) {
                    const baseEl = child.querySelector('.power-base');
                    const expEl = child.querySelector('.power-exp');
                    
                    // Get base - check for nested content
                    let base = '';
                    if (baseEl) {
                        if (baseEl.children.length > 0) {
                            base = serializeElement(baseEl);
                        } else {
                            base = baseEl.dataset.value || '';
                        }
                    }
                    
                    // Get exponent - check for nested content (like fractions)
                    let exp = '';
                    if (expEl) {
                        if (expEl.children.length > 0) {
                            exp = serializeElement(expEl);
                        } else {
                            exp = expEl.dataset.value || '';
                        }
                    }
                    
                    // Clean up [complex] markers
                    if (base === '[complex]') base = '';
                    if (exp === '[complex]') exp = '';
                    
                    result += `${base}^(${exp})`;
                } else if (child.classList.contains('math-fraction')) {
                    const numEl = child.querySelector('.fraction-num');
                    const denEl = child.querySelector('.fraction-den');
                    
                    // Get numerator - check for nested content
                    let num = '';
                    if (numEl) {
                        if (numEl.children.length > 0) {
                            num = serializeElement(numEl);
                        } else {
                            num = numEl.dataset.value || '';
                        }
                    }
                    
                    // Get denominator - check for nested content
                    let den = '';
                    if (denEl) {
                        if (denEl.children.length > 0) {
                            den = serializeElement(denEl);
                        } else {
                            den = denEl.dataset.value || '';
                        }
                    }
                    
                    // Clean up [complex] markers
                    if (num === '[complex]') num = '';
                    if (den === '[complex]') den = '';
                    
                    result += `(${num})/(${den})`;
                } else if (child.children.length > 0) {
                    result += serializeElement(child);
                }
            }
            
            return result;
        }

        // Initialize editor
        function initEditor() {
            const editor = document.getElementById('mathEditor');
            editor.innerHTML = '';
            
            const initialSlot = createSlot('main');
            editor.appendChild(initialSlot);
            setActiveSlot(initialSlot);
            
            // Click on editor focuses
            editor.addEventListener('click', (e) => {
                if (e.target.classList.contains('math-slot')) {
                    setActiveSlot(e.target);
                } else {
                    // Click anywhere on editor - ensure slot exists and focus it
                    ensureSlotExists();
                    const slots = getAllSlots();
                    if (slots.length > 0 && !editorState.activeSlot) {
                        setActiveSlot(slots[slots.length - 1]);
                    }
                }
                editor.focus();
            });
            
            // Focus handler - ensure slot is active when editor gets focus
            editor.addEventListener('focus', () => {
                ensureSlotExists();
            });
            
            // Keyboard navigation
            editor.addEventListener('keydown', (e) => {
                // Ensure we have a slot before processing keys
                ensureSlotExists();
                
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateSlot('left');
                } else if (e.key === 'ArrowRight' || e.key === 'Tab') {
                    e.preventDefault();
                    navigateSlot('right');
                } else if (e.key === 'Backspace') {
                    e.preventDefault();
                    backspaceSlot();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (document.getElementById('feedback').classList.contains('show')) {
                        nextProblem();
                    } else {
                        checkAnswer();
                    }
                } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                    // Single character input
                    e.preventDefault();
                    insertIntoSlot(e.key);
                }
            });
        }

        function showProblem(problemData) {
            state.currentProblem = problemData;
            
            document.getElementById('problemType').textContent = problemData.typeName;
            document.getElementById('instruction').textContent = problemData.instruction;
            document.getElementById('problemExpression').innerHTML = problemData.problem;
            
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = problemData.difficulty.charAt(0).toUpperCase() + problemData.difficulty.slice(1);
            badge.className = `difficulty-badge ${problemData.difficulty}`;
            
            // Reset editor
            const editor = document.getElementById('mathEditor');
            editor.classList.remove('correct', 'incorrect');
            clearEditor();
            
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('mathEditor').focus();
            
            // Update theory
            if (theoryContent[problemData.type]) {
                document.getElementById('theoryContent').innerHTML = theoryContent[problemData.type];
            }
        }

        // Normalize answer for comparison
        function normalizeAnswer(ans) {
            let normalized = ans
                .replace(/‚Å¥‚àö/g, '4thrt')  // Must come before ‚àö
                .replace(/¬≥‚àö/g, 'cbrt')   // Must come before ‚àö
                .replace(/‚Å¥/g, '4')       // Standalone superscript 4
                .replace(/¬≥/g, '3')       // Standalone superscript 3
                .replace(/¬≤/g, '^2')      // Superscript 2
                .replace(/¬π/g, '^1')      // Superscript 1
                .replace(/‚àö/g, 'sqrt')
                .toLowerCase()
                .replace(/\s/g, '')
                .replace(/¬∑/g, '*')
                .replace(/√ó/g, '*')
                .replace(/√∑/g, '/')
                .replace(/‚àí/g, '-')
                .replace(/\*\*/g, '^')
                .replace(/2sqrt/g, 'sqrt')
                .replace(/\)\(/g, ')*(');
            
            // Normalize root notations - handle all variations
            normalized = normalized.replace(/4throot/g, '4thrt');
            normalized = normalized.replace(/fourthroot/g, '4thrt');
            normalized = normalized.replace(/4thrt\^1(?!\d)/g, '4thrt'); // Remove ^1 after 4thrt
            
            // Normalize coefficient*sqrt format: 6*sqrt2 -> 6sqrt2, 6 * sqrt(2) -> 6sqrt2
            normalized = normalized.replace(/(\d+)\*sqrt/g, '$1sqrt');
            normalized = normalized.replace(/(\d+)\*cbrt/g, '$1cbrt');
            normalized = normalized.replace(/(\d+)\*4thrt/g, '$14thrt');
            
            // Normalize power notation: ^(2) -> ^2 for single digits
            normalized = normalized.replace(/\^\((\d)\)/g, '^$1');
            
            // Normalize x^1 to x (and x to x^1 for comparison)
            normalized = normalized.replace(/\^1(?!\d)/g, ''); // Remove ^1 (but not ^10, ^11, etc)
            
            // Remove unnecessary parentheses around single variables/numbers
            // sqrt(a) -> sqrta for single chars
            normalized = normalized.replace(/sqrt\(([a-z0-9])\)/g, 'sqrt$1');
            normalized = normalized.replace(/cbrt\(([a-z0-9])\)/g, 'cbrt$1');
            normalized = normalized.replace(/4thrt\(([a-z0-9])\)/g, '4thrt$1');
            
            // Handle sqrt(x^2) format - keep normalized
            normalized = normalized.replace(/sqrt\(([a-z])\^(\d+)\)/g, 'sqrt($1^$2)');
            normalized = normalized.replace(/cbrt\(([a-z])\^(\d+)\)/g, 'cbrt($1^$2)');
            normalized = normalized.replace(/4thrt\(([a-z])\^(\d+)\)/g, '4thrt($1^$2)');
            
            // Handle (sqrt...) patterns - remove outer parens around sqrt expressions
            normalized = normalized.replace(/\((sqrt[a-z0-9^()]+)\)/g, '$1');
            normalized = normalized.replace(/\((cbrt[a-z0-9^()]+)\)/g, '$1');
            normalized = normalized.replace(/\((4thrt[a-z0-9^()]+)\)/g, '$1');
            
            // Also handle cases like (a)/(b) -> a/b for single chars
            normalized = normalized.replace(/\(([a-z0-9])\)/g, '$1');
            
            // Handle nested parens: ((x)) -> x
            while (normalized.includes('((')) {
                normalized = normalized.replace(/\(\(([^()]+)\)\)/g, '($1)');
            }
            
            return normalized;
        }
        
        // Check if two math expressions are equivalent
        function areEquivalent(userAns, correctAns) {
            // Direct match
            if (userAns === correctAns) return true;
            
            // If both are simple numbers, they must match exactly
            const isSimpleNumber = (s) => /^-?\d+(\.\d+)?$/.test(s.trim());
            if (isSimpleNumber(userAns) && isSimpleNumber(correctAns)) {
                return parseFloat(userAns) === parseFloat(correctAns);
            }
            
            // Try removing all parentheses for simple expressions
            const stripParens = (s) => s.replace(/[()]/g, '');
            if (stripParens(userAns) === stripParens(correctAns)) return true;
            
            // Handle x = x^1 equivalence more thoroughly
            const normalizeExponent = (s) => {
                // Add ^1 to bare variables for comparison, then normalize
                let result = s;
                // Match single variable not followed by ^ 
                result = result.replace(/([a-z])(?!\^)(?![a-z0-9])/g, '$1^1');
                // Now remove all ^1
                result = result.replace(/\^1(?!\d)/g, '');
                return result;
            };
            
            if (normalizeExponent(userAns) === normalizeExponent(correctAns)) return true;
            if (normalizeExponent(stripParens(userAns)) === normalizeExponent(stripParens(correctAns))) return true;
            
            // Only do component extraction if there are variables or radicals involved
            const hasVarsOrRadicals = (s) => /[a-z]|sqrt|cbrt|4thrt|‚àö/.test(s);
            if (!hasVarsOrRadicals(userAns) && !hasVarsOrRadicals(correctAns)) {
                return false; // Simple expressions without variables - must match exactly
            }
            
            // Extract the key components: root type, variable, and power
            const extractComponents = (s) => {
                const rootMatch = s.match(/(sqrt|cbrt|4thrt)/);
                const varMatch = s.match(/[a-z]/g);
                const powMatch = s.match(/\^(\d+)/);
                return {
                    root: rootMatch ? rootMatch[1] : null,
                    vars: varMatch ? varMatch.sort().join('') : '',
                    pow: powMatch ? powMatch[1] : '1' // Default to 1 if no power
                };
            };
            
            const userComp = extractComponents(userAns);
            const correctComp = extractComponents(correctAns);
            
            // Check if root type, variables, and power all match
            if (userComp.root === correctComp.root && 
                userComp.vars === correctComp.vars && 
                userComp.pow === correctComp.pow) {
                return true;
            }
            
            return false;
        }

        function checkAnswer() {
            const rawUserAnswer = getEditorValue();
            const userAnswer = normalizeAnswer(rawUserAnswer);
            const correctAnswer = normalizeAnswer(state.currentProblem.answer);
            
            // Debug logging
            console.log('=== ANSWER CHECK DEBUG ===');
            console.log('Raw user answer:', rawUserAnswer);
            console.log('Original correct:', state.currentProblem.answer);
            console.log('Normalized user:', userAnswer);
            console.log('Normalized correct:', correctAnswer);
            
            // Parse answers for comparison (handle multiple solutions)
            const parseAnswers = (ans) => {
                return ans.split(',').map(a => a.trim()).filter(a => a.length > 0).sort().join(',');
            };
            
            const userParsed = parseAnswers(userAnswer);
            const correctParsed = parseAnswers(correctAnswer);
            
            // Count expected answers
            const expectedAnswerCount = correctParsed.split(',').length;
            const userAnswerCount = userParsed.split(',').filter(a => a.length > 0).length;
            
            console.log('Expected answer count:', expectedAnswerCount, 'User answer count:', userAnswerCount);
            
            // Check if answers match - try multiple methods
            let isCorrect = userParsed === correctParsed;
            console.log('Direct match:', isCorrect);
            
            // For problems with multiple answers, user must provide all of them
            // Only use fallback checks for single-answer problems (typically radical problems)
            const isMultiAnswerProblem = expectedAnswerCount > 1;
            
            if (isMultiAnswerProblem) {
                // For multiple answer problems, require exact count and matching values
                if (userAnswerCount !== expectedAnswerCount) {
                    console.log('Multi-answer problem: user provided', userAnswerCount, 'answers, expected', expectedAnswerCount);
                    isCorrect = false;
                } else {
                    // Compare each answer (allowing for some numeric tolerance)
                    const userNums = userParsed.split(',').map(s => parseFloat(s.replace(/[^0-9.-]/g, ''))).sort((a,b) => a-b);
                    const correctNums = correctParsed.split(',').map(s => parseFloat(s.replace(/[^0-9.-]/g, ''))).sort((a,b) => a-b);
                    
                    console.log('User numbers:', userNums, 'Correct numbers:', correctNums);
                    
                    if (userNums.length === correctNums.length) {
                        isCorrect = userNums.every((num, i) => {
                            const diff = Math.abs(num - correctNums[i]);
                            return diff < 0.01 || (correctNums[i] !== 0 && diff / Math.abs(correctNums[i]) < 0.01);
                        });
                    }
                }
                console.log('After multi-answer check:', isCorrect);
            } else {
                // Single answer problem - use all the fallback checks for radicals etc.
                
                // Check if this is a radical problem (contains sqrt, cbrt, root symbols)
                const isRadicalProblem = (s) => {
                    return s.includes('sqrt') || s.includes('cbrt') || s.includes('4thrt') || 
                           s.includes('‚àö') || s.includes('root') || s.includes('R');
                };
                
                const problemInvolvesRadicals = isRadicalProblem(correctAnswer) || isRadicalProblem(userAnswer);
                
                // If not exact match, try equivalence check
                if (!isCorrect) {
                    isCorrect = areEquivalent(userAnswer, correctAnswer);
                    console.log('After areEquivalent:', isCorrect);
                }
            
            // Only apply radical-specific checks if the problem involves radicals
            if (problemInvolvesRadicals) {
            
                // Additional check: strip all non-essential characters and compare
                if (!isCorrect) {
                    const simplify = (s) => s.replace(/[()^]/g, '').replace(/sqrt|cbrt|4thrt|4throot/g, 'R');
                    const userSimp = simplify(userAnswer);
                    const correctSimp = simplify(correctAnswer);
                    
                    console.log('Simplify check - user:', userSimp, 'correct:', correctSimp);
                    
                    if (userSimp === correctSimp) {
                        // Same content, just formatted differently
                        // Verify it has the right root type
                        const userRoot = userAnswer.includes('4thrt') || userAnswer.includes('4throot') ? '4' :
                                        userAnswer.includes('cbrt') ? '3' : 
                                        userAnswer.includes('sqrt') ? '2' : '0';
                        const correctRoot = correctAnswer.includes('4thrt') || correctAnswer.includes('4throot') ? '4' :
                                           correctAnswer.includes('cbrt') ? '3' : 
                                           correctAnswer.includes('sqrt') ? '2' : '0';
                        
                        if (userRoot === correctRoot) {
                            isCorrect = true;
                        }
                    }
                }
                
                // Check for algebraic expression equivalence (multi-variable, fractions)
                if (!isCorrect) {
                    const normalizeAlgebraic = (s) => {
                        return s
                            .replace(/\s/g, '')
                            .replace(/\*/g, '')        // Remove all multiplication signs
                            .replace(/\(([^()]+)\)/g, '$1')  // Remove parentheses
                            .replace(/\^1(?!\d)/g, '')  // Remove ^1
                            .toLowerCase();
                    };
                    
                    const userAlg = normalizeAlgebraic(userAnswer);
                    const correctAlg = normalizeAlgebraic(correctAnswer);
                    
                    console.log('Algebraic check - user:', userAlg, 'correct:', correctAlg);
                    
                    if (userAlg === correctAlg) {
                        isCorrect = true;
                    }
                }
            
            // Final fallback: extract variable, power, and root type and compare
            if (!isCorrect) {
                const extractAll = (s) => {
                    const root = s.includes('cbrt') ? 'cbrt' : 
                                 (s.includes('4thrt') || s.includes('4throot')) ? '4thrt' : 
                                 (s.includes('sqrt') ? 'sqrt' : 'none');
                    const vars = (s.match(/[a-z]/g) || []).sort().join('');
                    // Get powers, but filter out the '4' from '4thrt' or '4th'
                    let powers = s.replace(/4th(rt|root)?/g, '').match(/\d+/g) || [];
                    // If no power found, it's implicitly 1
                    if (powers.length === 0) powers = ['1'];
                    // Sort and join
                    const powerStr = powers.sort().join(',');
                    return `${root}:${vars}:${powerStr}`;
                };
                
                console.log('Final check - user:', extractAll(userAnswer), 'correct:', extractAll(correctAnswer));
                
                if (extractAll(userAnswer) === extractAll(correctAnswer)) {
                    isCorrect = true;
                }
            }
            
            // Extra fallback: just compare root type and variables (for simple cases like ‚Å¥‚àöb = 4th root(b))
            if (!isCorrect) {
                const extractSimple = (s) => {
                    const root = s.includes('cbrt') ? 'cbrt' : 
                                 (s.includes('4thrt') || s.includes('4throot')) ? '4thrt' : 
                                 (s.includes('sqrt') ? 'sqrt' : 'none');
                    const vars = (s.match(/[a-z]/g) || []).sort().join('');
                    // Check if there's a power greater than 1
                    const powersInContent = s.replace(/4th(rt|root)?/g, '').replace(/sqrt|cbrt/g, '').match(/\d+/g) || [];
                    const hasPower = powersInContent.some(p => parseInt(p) > 1);
                    return `${root}:${vars}:${hasPower}`;
                };
                
                console.log('Simple check - user:', extractSimple(userAnswer), 'correct:', extractSimple(correctAnswer));
                
                if (extractSimple(userAnswer) === extractSimple(correctAnswer)) {
                    isCorrect = true;
                }
            }
            
            // Ultimate fallback: normalize heavily and compare core content
            if (!isCorrect) {
                const ultraSimplify = (s) => {
                    // Remove all formatting, keep only: root type indicator + variables + numbers
                    let simplified = s.toLowerCase()
                        .replace(/\^1(?!\d)/g, '') // Remove ^1 (power of 1 = no power)
                        .replace(/4throot|4thrt/g, '4R')
                        .replace(/cbrt/g, '3R')
                        .replace(/sqrt/g, '2R')
                        .replace(/[^a-z0-9r]/g, ''); // Remove everything except alphanumeric and R
                    return simplified;
                };
                
                console.log('Ultra simple - user:', ultraSimplify(userAnswer), 'correct:', ultraSimplify(correctAnswer));
                
                if (ultraSimplify(userAnswer) === ultraSimplify(correctAnswer)) {
                    isCorrect = true;
                }
            }
            
            // Final final fallback: compare just root type and variable
            if (!isCorrect) {
                const rootAndVar = (s) => {
                    const root = s.includes('4thrt') || s.includes('4throot') ? '4' : 
                                 s.includes('cbrt') ? '3' : 
                                 s.includes('sqrt') ? '2' : '0';
                    const vars = (s.match(/[a-z]/g) || []).sort().join('');
                    // Only get powers > 1
                    const significantPowers = (s.replace(/4th(rt|root)?|sqrt|cbrt/g, '').match(/\d+/g) || [])
                        .filter(p => parseInt(p) > 1)
                        .sort()
                        .join(',');
                    return `${root}:${vars}:${significantPowers}`;
                };
                
                console.log('Root+Var check - user:', rootAndVar(userAnswer), 'correct:', rootAndVar(correctAnswer));
                
                if (rootAndVar(userAnswer) === rootAndVar(correctAnswer)) {
                    isCorrect = true;
                }
            }
            
            // ABSOLUTE FINAL: Just check root index + variable + any number > 1
            if (!isCorrect) {
                const absoluteFinal = (s) => {
                    // Normalize the string first - remove spaces and convert Unicode
                    let normalized = s
                        .replace(/‚Å¥‚àö/g, '4THRT').replace(/¬≥‚àö/g, 'CBRT').replace(/‚àö/g, 'SQRT')
                        .replace(/‚Å¥/g, '4').replace(/¬≥/g, '3').replace(/¬≤/g, '2').replace(/¬π/g, '1')
                        .toLowerCase()
                        .replace(/\s/g, '');
                    
                    // Determine root type
                    let rootIdx = '2';
                    if (normalized.includes('4thrt') || normalized.includes('4throot')) rootIdx = '4';
                    else if (normalized.includes('cbrt')) rootIdx = '3';
                    else if (normalized.includes('sqrt')) rootIdx = '2';
                    
                    // Remove root notation to get just the content
                    const content = normalized
                        .replace(/4thrt|4throot|cbrt|sqrt/g, '')
                        .replace(/[()^]/g, '');
                    
                    // Get variable(s) - only a-z that aren't part of root notation
                    const vars = (content.match(/[a-z]/g) || []).sort().join('');
                    
                    // Get exponent numbers (filter out 1)
                    const allNums = content.match(/\d+/g) || [];
                    const expNums = allNums.filter(n => n !== '1').sort().join('');
                    
                    return `R${rootIdx}:${vars}:${expNums}`;
                };
                
                const userFinal = absoluteFinal(rawUserAnswer);
                const correctFinal = absoluteFinal(state.currentProblem.answer);
                
                console.log('ABSOLUTE FINAL - user:', userFinal, 'correct:', correctFinal);
                
                if (userFinal === correctFinal) {
                    isCorrect = true;
                }
            }
            
            // SUPER FINAL: Extract root index from visual, get ALL numbers from both, compare
            if (!isCorrect) {
                const superFinal = (s, isVisual = false) => {
                    let rootIdx = '2';
                    
                    // Check for visual unicode root symbols
                    if (s.includes('‚Å¥') || s.includes('‚Å¥‚àö')) rootIdx = '4';
                    else if (s.includes('¬≥') || s.includes('¬≥‚àö')) rootIdx = '3';
                    // Check for text root notation
                    else if (s.toLowerCase().includes('4th')) rootIdx = '4';
                    else if (s.toLowerCase().includes('cbrt')) rootIdx = '3';
                    else if (s.includes('‚àö') || s.toLowerCase().includes('sqrt')) rootIdx = '2';
                    
                    // Get variables
                    const vars = (s.match(/[a-z]/gi) || []).map(v => v.toLowerCase()).sort().join('');
                    
                    // For exponent, look for ^number or superscript patterns
                    let exp = '';
                    const expMatch = s.match(/\^[\(\[]?(\d+)/);
                    if (expMatch) {
                        exp = expMatch[1];
                    } else {
                        // Look for any number that's not 1, 2, 3, or 4 (common root indices)
                        const nums = s.replace(/[‚Å¥¬≥‚àö]|4th|sqrt|cbrt/gi, '').match(/\d+/g) || [];
                        const significantNums = nums.filter(n => !['1', '2', '3', '4'].includes(n) || 
                            (nums.length === 1 && n !== '1')); // Keep if it's the only number and not 1
                        if (significantNums.length > 0) {
                            exp = significantNums.sort().join(',');
                        }
                    }
                    
                    // If exp is still empty but we have nums, check if any > 1
                    if (!exp) {
                        const allNums = s.replace(/4th/gi, '').match(/\d+/g) || [];
                        const bigNums = allNums.filter(n => parseInt(n) > 1 && n !== rootIdx);
                        if (bigNums.length > 0) {
                            exp = bigNums.sort().join(',');
                        }
                    }
                    
                    return `R${rootIdx}:${vars}:${exp}`;
                };
                
                const userSuper = superFinal(rawUserAnswer, true);
                const correctSuper = superFinal(state.currentProblem.answer, false);
                
                console.log('SUPER FINAL - user:', userSuper, 'correct:', correctSuper);
                
                if (userSuper === correctSuper) {
                    isCorrect = true;
                }
            }
            } // End of problemInvolvesRadicals check
            } // End of single-answer problem fallback checks
            
            const editor = document.getElementById('mathEditor');
            const feedback = document.getElementById('feedback');
            
            state.stats.total++;
            
            if (isCorrect) {
                state.stats.correct++;
                state.stats.streak++;
                editor.classList.add('correct');
                feedback.className = 'feedback correct show';
                document.getElementById('feedbackIcon').textContent = '‚úì';
                document.getElementById('feedbackTitle').textContent = 'Correct!';
            } else {
                state.stats.incorrect++;
                state.stats.streak = 0;
                editor.classList.add('incorrect');
                feedback.className = 'feedback incorrect show';
                document.getElementById('feedbackIcon').textContent = '‚úó';
                document.getElementById('feedbackTitle').textContent = `Incorrect. Answer: ${state.currentProblem.answer}`;
            }
            
            document.getElementById('feedbackExplanation').innerHTML = state.currentProblem.explanation;
            updateStats();
        }

        function nextProblem() {
            const generator = problemGenerators[state.currentTopic];
            if (generator) {
                showProblem(generator());
            }
        }

        function setTopic(topic) {
            if (!problemGenerators[topic]) return;
            
            state.currentTopic = topic;
            
            document.querySelectorAll('.topic-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.topic === topic) {
                    btn.classList.add('active');
                }
            });
            
            nextProblem();
        }

        // Event Listeners
        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        document.getElementById('nextBtn').addEventListener('click', nextProblem);

        // Math keyboard handlers
        document.querySelectorAll('.math-key').forEach(key => {
            key.addEventListener('click', (e) => {
                e.preventDefault();
                const action = key.dataset.action;
                const template = key.dataset.template;
                const char = key.dataset.char;
                
                if (action === 'backspace') {
                    backspaceSlot();
                    document.getElementById('mathEditor').focus();
                } else if (action === 'clear') {
                    clearEditor();
                    document.getElementById('mathEditor').focus();
                } else if (action === 'left') {
                    navigateSlot('left');
                } else if (action === 'right') {
                    navigateSlot('right');
                } else if (template) {
                    insertTemplate(template);
                } else if (char) {
                    insertIntoSlot(char);
                    document.getElementById('mathEditor').focus();
                }
            });
        });

        document.querySelectorAll('.topic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.classList.contains('locked')) {
                    setTopic(btn.dataset.topic);
                }
            });
        });

        document.getElementById('theoryToggle').addEventListener('click', () => {
            const toggle = document.getElementById('theoryToggle');
            const content = document.getElementById('theoryContent');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        });

        // Initialize
        initEditor();
        nextProblem();
    </script>
</body>
</html>
